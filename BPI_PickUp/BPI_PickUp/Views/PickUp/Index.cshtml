


<div class="container-fluid mb-4" style="font-family: Kanit;">
    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <button id="NewBtn" class="btn btn-success mx-1">
                <i class="fa-solid fa-file"></i> เริ่มรายใหม่
            </button>
            <button id="copyBtn" class="btn btn-warning mx-1" style="display: none;">
                <i class="fa-solid fa-copy"></i> คัดลอก
            </button>
            <button id="sendForApprovalBtn" class="btn btn-primary mx-1" style="display: none;">
                <i class="fa-solid fa-paper-plane"></i> ส่งอนุมัติ
            </button>
            <button id="printBtn" class="btn btn-success mx-1 ms-auto" style="display: none;">
                <i class="fa-solid fa-print"></i> พิมพ์รายงาน
            </button>
        </div>
        <div class="card-body" style="font-size: 15px;">
            <form>
                <div class="row mb-3">
                    <label class="col-sm-1 col-form-label">เลขที่เอกสาร</label>
                    <div class="col-sm-3">
                        <div class="input-group">
                            <input id="documentNumber" type="text" class="form-control" placeholder="ค้นหาเลขเอกสาร">
                            <span class="input-group-text">
                                <i class="fa-solid fa-qrcode"></i>
                            </span>
                        </div>
                    </div>

                    <label class="col-sm-1 col-form-label">วันที่</label>
                    <div class="col-sm-3">
                        <div class="input-group">
                            <input id="date" type="date" class="form-control">
                        </div>
                    </div>

                    <label class="col-sm-1 col-form-label">Plant</label>
                    <div class="col-sm-3">
                        <select id="plant" class="form-control selectpicker" data-live-search="true">
                            <option disabled selected>--- เลือกประเภทรถ ---</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <label class="col-sm-1 col-form-label">เหตุผล</label>
                    <div class="col-sm-3">
                        <select id="reason" class="form-control selectpicker" data-live-search="true">
                            <option disabled selected>--- เลือกประเภทรถ ---</option>
                        </select>
                    </div>

                    <label class="col-sm-1 col-form-label">หน่วยงาน</label>
                    <div class="col-sm-2">
                        <select id="dep" class="form-control selectpicker" data-live-search="true">
                            <option disabled selected>--- เลือกประเภทรถ ---</option>
                        </select>
                    </div>

                    <label class="col-sm-2 col-form-label">วันที่ต้องการสินค้า (store จ่ายของ)</label>
                    <div class="col-sm-3">
                        <div class="input-group">
                            <input id="requiredDate" type="date" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <label class="col-sm-12 col-md-1 col-form-label">หมายเหตุ</label>
                    <div class="col-sm-3">
                        <div class="input-group">
                            <input id="remarks" type="text" class="form-control" placeholder="กรอกหมายเหตุเบิกของ">
                        </div>
                    </div>

                    <label class="col-sm-1 col-form-label">สถานะ</label>
                    <div class="col-sm-3">
                        <div class="input-group">
                            <input id="status" type="text" class="form-control" readonly>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <button id="AddBtn" class="btn btn-success">
                    <i class="fa-solid fa-plus"></i>
                </button>
                <button id="searchPartBtn" class="btn btn-primary" disabled="true">
                    <i class="fa-solid fa-magnifying-glass"></i> ค้นหา Part
                </button>
            </div>
        </div>
        <table id="table" class="table table-bordered" style="font-size: 14px;">
            <thead class="table-info text-center">
                <tr>
                    <th data-field="partnum">รหัสสินค้า</th>
                    <th data-field="description">รายละเอียด</th>
                    <th data-field="quantity">จำนวน</th>
                    <th data-field="unit">หน่วย</th>
                    <th data-field="warehouse">คลัง</th>
                    <th data-field="bin">Bin</th>
                    <th data-field="action">Action</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div class="d-flex justify-content-end mt-3">
            <button id="SaveBtn" class="btn btn-warning mx-2" style="display: none;">
                <i class="fa-solid fa-save"></i> บันทึกข้อมูล
            </button>
            <button id="cancelBtn" class="btn btn-danger" style="display: none;">
                <i class="fa-solid fa-times"></i> ยกเลิก
            </button>
        </div>
    </div>

    <div class="modal fade" id="searchPartModal" tabindex="-1" role="dialog" aria-labelledby="searchPartLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchPartLabel">ค้นหา Part Number</h5>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <label class="col-sm-3 col-form-label">Part Num</label>
                        <div class="col-sm-6">
                            <div class="input-group">
                                <input id="partNumModal" type="text" class="form-control" placeholder="กรอกหมายเหตุเบิกของ">
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <label class="col-sm-3 col-form-label">Part Descriptions</label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <input id="partDescModal" type="text" class="form-control">
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">รายละเอียด</h5>
                    <table id="partResults" class="table table-bordered table-hover">
                        <thead class="table-info text-center">
                            <tr>
                                <th data-field="state" data-checkbox="true"></th>
                                <th data-field="partnum">รหัสสินค้า</th>
                                <th data-field="description">รายละเอียด</th>
                                <th data-field="unit">หน่วย</th>
                            </tr>
                        </thead>
                        <tbody id="partSearchResults">
                            <!-- Results will be appended here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button id="selectPartBtn" type="button" class="btn btn-warning">
                        <i class="fa-solid fa-check"></i>
                    </button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    $(document).ready(function () {
        $('.selectpicker').selectpicker();
        $('#table').bootstrapTable();

        function showLoadingOverlay() {
            $.LoadingOverlay("show", {
                image: "",
                fontawesome: "fa-solid fa-truck-front fa-bounce",
            });
        }

        function hideLoadingOverlay() {
            $.LoadingOverlay("hide");
        }

        function loadFormData() {
            showLoadingOverlay();

            $.ajax({
                url: '/PickUp/GetFormData',
                method: 'GET',
                success: function (response) {
                    if (response.success) {
                        var result = response;

                        populateSelectOptions('#plant', result.plant);
                        populateSelectOptions('#reason', result.reason);
                        populateSelectOptions('#dep', result.dep);

                        hideLoadingOverlay();
                    }
                },
                error: function () {
                    hideLoadingOverlay();
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                    });
                }
            });
        }

        function populateSelectOptions(selector, options) {
            var $select = $(selector);
            $select.empty();
            $select.append('<option disabled selected>--- เลือกข้อมูล ---</option>');
            $select.selectpicker('destroy');

            $.each(options, function (index, option) {
                $select.append($('<option>', {
                    value: option.value,
                    text: option.text
                }));
            });

            $select.selectpicker();
        }

        loadFormData();

        $('#AddBtn').on('click', function (e) {
            e.preventDefault();

            var $table = $('#table');
            var data = $table.bootstrapTable('getData');

            $('#searchPartBtn').prop('disabled', false);
            $('#SaveBtn').show();

            if (data.length === 0) {
                $table.bootstrapTable('destroy');
                $table.find('tbody').empty();
            }

            var newRow = `
                <tr>
                    <td><input type="text" class="form-control partNum" placeholder="รหัสสินค้า"></td>
                    <td><input type="text" class="form-control desc" placeholder="รายละเอียดสินค้า"></td>
                    <td><input type="number" class="form-control quantity" placeholder="จำนวน"></td>
                    <td><input type="text" class="form-control unit" placeholder="จำนวน"></td>
                    <td>
                        <select class="form-control warehouse">
                            <option disabled selected>เลือกคลังสินค้า</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-control bin">
                            <option disabled selected>เลือกบินสินค้า</option>
                        </select>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-danger btn-sm delete-row">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;

            $('#table tbody').append(newRow);
            $('#table tbody tr').last().addClass('editing');
        });

        $('#searchPartBtn').on('click', function () {
            // แสดง Modal เมื่อกดปุ่มค้นหา Part
            $('#searchPartModal').modal('show');

            $('#partNumModal').on('input', function () {
                var query = $(this).val();
                if (query.length >= 3) {
                    $.ajax({
                        url: '/PickUp/SearchPartModal',
                        method: 'GET',
                        data: { query: query },
                        success: function (response) {
                            if (response.success) {
                                $('#partResults').bootstrapTable('load', response.data);
                            } else {
                                $('#partResults').bootstrapTable('load', [{
                                    partNum: '',
                                    description: 'ไม่พบข้อมูล',
                                    unit: ''
                                }]);
                            }
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                            });
                        }
                    });
                }
            });

            $('#partDescModal').on('input', function () {
                var query = $(this).val();
                if (query.length >= 3) {
                    $.ajax({
                        url: '/PickUp/SearchPartModal',
                        method: 'GET',
                        data: { partDesc: query },
                        success: function (response) {
                            if (response.success) {
                                $('#partResults').bootstrapTable('load', response.data);
                            } else {
                                $('#partResults').bootstrapTable('load', [{
                                    partNum: '',
                                    description: 'ไม่พบข้อมูล',
                                    unit: ''
                                }]);
                            }
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                            });
                        }
                    });
                }
            });

        });

        $('#selectPartBtn').on('click', function () {
            var selectedRows = $('#partResults').bootstrapTable('getSelections');
            var selectedPartNums = selectedRows.map(row => row.partNum);

            var $currentRow = $('#table tbody tr.editing');

            if ($currentRow.length) {
                $currentRow.find('.partNum').val(selectedPartNums.join(', '));
                $currentRow.removeClass('editing');
                $currentRow.focus();

            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่มีแถวที่กำลังแก้ไข',
                    text: 'กรุณาเลือกแถวที่ต้องการแก้ไขก่อน',
                });
            }

            $('#searchPartModal').modal('hide');
        });

        $('#table').on('click', '.delete-row', function () {
            $(this).closest('tr').remove();
        });

        $('#table').on('keypress', '.partNum', function (e) {
            if (e.which === 13) {
                e.preventDefault();

                var $row = $(this).closest('tr');
                var partNum = $(this).val();

                $.ajax({
                    url: '/PickUp/GetPartNum',
                    method: 'GET',
                    data: { partNum: partNum },
                    success: function (response) {
                        if (response.success) { 

                            var part = response.searchPart[0];

                            $row.find('.partNum').val(part.partNum);
                            $row.find('.desc').val(part.partDescription);
                            // $row.find('.quantity').val();
                            $row.find('.unit').val(part.ium);
                            
                            var $warehouseDropdown = $row.find('.warehouse');
                            var $binDropdown = $row.find('.bin');
                            $warehouseDropdown.empty();
                            $binDropdown.empty();

                            $.each(response.searchWh, function (index, warehouseCode) {
                                $warehouseDropdown.append($('<option>', {
                                    value: warehouseCode,
                                    text: warehouseCode
                                }));
                            });

                            $.each(response.searchBin, function (index, binNum) {
                                $binDropdown.append($('<option>', {
                                    value: binNum,
                                    text: binNum
                                }));
                            });

                            $row.find('.quantity').focus();
                        } else {
                            Swal.fire({
                                icon: 'warning',
                                title: 'ไม่พบข้อมูล',
                                text: 'ไม่พบรหัสสินค้านี้ในระบบ กรุณากรอกใหม่',
                            }).then(() => {

                                $row.find('.partNum').val('');
                                $row.find('.partNum').focus();
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                        })
                    }
                });
            }
        });

        $('#NewBtn').on('click', function (e) {
            e.preventDefault();

            $('form').trigger('reset');

            $('#plant').selectpicker('destroy');
            $('#reason').selectpicker('destroy');
            $('#dep').selectpicker('destroy');

            $('#table').bootstrapTable('destroy');
            $('#table tbody').empty();
        });

        $('#SaveBtn').on('click', function () {
            var formData = {
                documentNumber: $('#documentNumber').val(),
                date: $('#date').val(),
                plant: $('#plant').val(),
                reason: $('#reason').val(),
                department: $('#dep').val(),
                requiredDate: $('#requiredDate').val(),
                remarks: $('#remarks').val(),
                status: $('#status').val(),
                parts: []
            };

            $('#table tbody tr').each(function () {
                var $row = $(this);
                var part = {
                    partNum: $row.find('.partNum').val(),
                    description: $row.find('.desc').val(),
                    quantity: $row.find('.quantity').val(),
                    unit: $row.find('.unit').val(),
                    warehouse: $row.find('.warehouse').val(),
                    bin: $row.find('.bin').val()
                };
                formData.parts.push(part);
            });

            $.ajax({
                url: '/PickUp/SaveDocument',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'สำเร็จ',
                            text: 'บันทึกเรียบร้อยแล้ว',
                        });

                        $('#status').val('บันทึก');
                        $('#sendForApprovalBtn').show();
                        $('#cancelBtn').show();
                        $('#searchPartBtn').prop('disabled', true);

                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'ผิดพลาด',
                            text: 'ไม่สามารถบันทึกข้อมูลได้',
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                    });
                }
            });
        });

        $('#documentNumber').on('keypress', function (e) {
            if (e.which === 13) {
                e.preventDefault();
                var documentNumber = $(this).val();

                $.ajax({
                    url: '/PickUp/GetDocumentData',
                    method: 'GET',
                    data: { documentNumber: documentNumber },
                    success: function (response) {
                        if (response.success) {

                            var data = response.getData[0];
                            var parts = response.dataWithDescriptions;

                            function convertDateFormat(dateStr) {
                                var parts = dateStr.split('/');
                                return `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }

                            var formattedDocDate = convertDateFormat(data.docDate);
                            var formattedReqDate = convertDateFormat(data.reqDate);


                            $('#date').val(formattedDocDate);
                            $('#plant').val(data.plant).selectpicker('destroy');
                            $('#reason').val(data.reason).selectpicker('destroy');
                            $('#dep').val(data.dep).selectpicker('destroy');
                            $('#requiredDate').val(formattedReqDate);
                            $('#remarks').val(data.remark);
                            $('#status').val(data.status);

                            // Clear existing table rows
                            $('#table tbody').empty();

                            // Add new rows to the table
                            $.each(parts, function (index, part) {
                                var newRow = `
                                    <tr>
                                        <td><input type="text" class="form-control partNum" value="${part.partNum}" readonly></td>
                                        <td><input type="text" class="form-control desc" value="${part.description}" readonly></td>
                                        <td><input type="number" class="form-control quantity" value="${part.qty}" readonly></td>
                                        <td><input type="text" class="form-control unit" value="${part.unit}" readonly></td>
                                        <td>
                                            <select class="form-control warehouse" disabled>
                                                <option value="${part.wareHouse}" selected>${part.wareHouse}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-control bin" disabled>
                                                <option value="${part.bin}" selected>${part.bin}</option>
                                            </select>
                                        </td>
                                        <td class="text-center">
                                            <button class="btn btn-danger btn-sm delete-row" disabled>
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                                $('#table tbody').append(newRow);
                            });

                            $('.selectpicker').selectpicker('refresh');

                            $('#AddBtn').prop('disabled', true);
                            
                        } else {
                            Swal.fire({
                                icon: 'warning',
                                title: 'ไม่พบข้อมูล',
                                text: 'ไม่พบเอกสารนี้ในระบบ กรุณาตรวจสอบเลขที่เอกสาร',
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                        });
                    }
                });
            }
        });

        $('#copyBtn').on('click', function () {

            $('form').trigger('reset');

            $('#table input').prop('readonly', false);
            $('#table select').prop('disabled', false);

            // $('#table .delete-row').prop('disabled', false);
        });
        
        $('#sendForApprovalBtn').on('click', function () {
            var documentNumber = $('#documentNumber').val();

            $.ajax({
                url: '/PickUp/SendForApproval',
                method: 'POST',
                data: { documentNumber: documentNumber },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ส่งคำขออนุมัติสำเร็จ',
                            text: 'เอกสารได้ถูกส่งไปยังผู้อนุมัติแล้ว',
                        });

                        $('#status').val('ส่งอนุมัติ');
                        $('#printBtn').prop('disabled', false);
                        $('#copyBtn').prop('disabled', false);

                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'ส่งคำขออนุมัติไม่สำเร็จ',
                            text: 'กรุณาตรวจสอบเอกสารและลองใหม่อีกครั้ง',
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                    });
                }
            });
        });

        $('#cancelBtn').on('click', function () {
            var documentNumber = $('#documentNumber').val();

            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: 'คุณต้องการยกเลิกเอกสารนี้หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ใช่, ยกเลิกเอกสาร!',
                cancelButtonText: 'ไม่, ยกเลิก',
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/PickUp/CancelDocument',
                        method: 'POST',
                        data: { documentNumber: documentNumber },
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'ยกเลิกเอกสารสำเร็จ',
                                    text: response.message,
                                });

                                $('#status').val('ยกเลิก');

                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ไม่สามารถยกเลิกเอกสารได้',
                                    text: response.message,
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'เกิดข้อผิดพลาด',
                                text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้',
                            });
                        }
                    });
                }
            });
        });

        $('#partResults').bootstrapTable({
            columns: [
                { field: 'state', checkbox: true },
                { field: 'partNum', title: 'รหัสสินค้า' },
                { field: 'partDescription', title: 'รายละเอียด' },
                { field: 'ium', title: 'หน่วย' }
            ],
            pagination: true,
            search: false, // ปิดการค้นหาในตารางเอง
            sortable: true,
            formatPaginationSwitch: function () {
                return 'แสดง/ซ่อน ตาราง';
            },
            formatRecordsPerPage: function (pageNumber) {
                return `แถวต่อหน้า ${pageNumber}`;
            },
            formatShowingRows: function (pageFrom, pageTo, totalRows) {
                return `แสดง ${pageFrom} ถึง ${pageTo} ของ ${totalRows} รายการ`;
            },
            formatSearch: function () {
                return 'ค้นหา';
            },
            formatNoMatches: function () {
                return 'ไม่พบข้อมูลที่ตรงกับการค้นหาของคุณ';
            }
        });

    });

</script>
